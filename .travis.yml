language: go
go:
  - 1.7
env:
  - VAULT_ADDR='http://127.0.0.1:8200'
services:
  - redis
  - docker
before_install:
  # install consul
#  - wget https://releases.hashicorp.com/consul/0.6.3/consul_0.6.3_linux_amd64.zip
#  - unzip consul_0.6.3_linux_amd64.zip
#  - sudo mv consul /bin/
#  - consul agent -server -bootstrap-expect 1 -data-dir /tmp/consul &
#  # install etcd
#  - wget https://github.com/coreos/etcd/releases/download/v2.2.5/etcd-v2.2.5-linux-amd64.tar.gz
#  - tar xzf etcd-v2.2.5-linux-amd64.tar.gz
#  - sudo mv etcd-v2.2.5-linux-amd64/etcd /bin/
#  - etcd &
#  # install DynamoDB
#  - mkdir /tmp/dynamodb
#  - wget -O - http://dynamodb-local.s3-website-us-west-2.amazonaws.com/dynamodb_local_latest | tar xz --directory /tmp/dynamodb
#  - java -Djava.library.path=/tmp/dynamodb/DynamoDBLocal_lib -jar /tmp/dynamodb/DynamoDBLocal.jar -inMemory &
#  # Install rancher metadata
#  - wget https://github.com/rancher/rancher-metadata/releases/download/v0.1.0/rancher-metadata.tar.gz
#  - mkdir -p ./rancher-metadata
#  - tar xzf rancher-metadata.tar.gz --strip-components=1 -C ./rancher-metadata
#  - sudo mv ./rancher-metadata/bin/rancher-metadata /bin/
#  # Install vault
#  - wget https://releases.hashicorp.com/vault/0.4.1/vault_0.4.1_linux_amd64.zip
#  - unzip vault_0.4.1_linux_amd64.zip
#  - sudo mv vault /bin/
#  - vault server -dev &
#  # Install zookeeper
#  - wget http://www.eu.apache.org/dist/zookeeper/zookeeper-3.4.8/zookeeper-3.4.8.tar.gz
#  - tar xzf zookeeper-3.4.8.tar.gz
#  - mkdir /tmp/zookeeper && cp integration/zookeeper/zoo.cfg zookeeper-3.4.8/conf/zoo.cfg
#  - zookeeper-3.4.8/bin/zkServer.sh start
  # Install metad
  - wget https://github.com/yunify/metad/releases/download/v1.2.1/metad-linux-amd64.tar.gz
  - tar -zxvf metad-linux-amd64.tar.gz
  - sudo mv metad /bin/
  # mv repo
  - echo $PWD
  - mkdir -p $GOPATH/src/github.com/kelseyhightower/
  - mv $GOPATH/src/github.com/yunify/confd $GOPATH/src/github.com/kelseyhightower/
  - cd $GOPATH/src/github.com/kelseyhightower/confd/
  - echo $PWD
install:
  - sudo pip install awscli
  - go get golang.org/x/tools/cmd/cover
  - ./build
  - sudo ./install
script:
  - ./test
#  - bash integration/consul/test.sh
#  - bash integration/env/test.sh
#  - bash integration/etcd/test.sh
#  - bash integration/redis/test.sh
#  - bash integration/rancher/test.sh
#  - bash integration/vault/test.sh
#  - bash integration/zookeeper/test.sh
#  - bash integration/dynamodb/test.sh
  - bash integration/metad/test.sh
before_deploy:
    - "./release"
deploy:
    provider: releases
    skip_cleanup: true
    api_key:
        secure: "ByY8NEdSfI3GmoDnr+HiaRDROzDaKiW8dnOOQvKbiiQE8Hy/L6rbBqVXo+ENthZhsdAaKFwu/A3xoNZCRRibnVl4rYyuOhTwqub3zuWUkE8QH/+a7cWdXkgB2/gMLtdo7b/hbh7G3koERRfTnbsJD/7gOmCbFpIIBFcY3Z7R/bghMXTgweuUGlFmXF5mIMwVIJDwES5Z54V/Uwn9LcZsNeaoYJGL1/a8ycOXU8KOHqrVFBTYzOkt3MHdy2is4pT7UDeQu/9WrYVQDsV8Ao4cMMrSmtOCwdFRU9HUbYq6/+e+Lh+h9hZlnstiUMYPIxbnei7dP1xNwZ/Sw+s5P+y2jc0jkPf+tUdsaofinhR4qvS2vcuT52zTMJQSr2ErWv215YC6ejrLz2KbKYw1Ovn123wAXes9mB5u5U0SctUXDMpiObPw4zsjIxp/JPHbQ4xpPIZj5qYaqu7y8vPoMC1X+6JfZcLAHcmaApI6Rol5FZTkwP2t2soXTFUB9cMIEFdzI63Hk9F67z1KY5BlCssukf+LM+m4g3d2ROrO83LBT5ckGT+sC8X+6Y6X/RNsPuJ/FBg3H3aR7ATpzoTH8prsB89BARsx3o0eg3jYX+9zodws5Wddpr/EP5nPuQOQNyyrNR8xtcO1B7HrKVzAllsLnksX8t7SSPgwyMrkXkIRiSg="
        file:
        - "bin/linux/confd-linux-amd64.tar.gz"
        - "bin/darwin/confd-darwin-amd64.tar.gz"
        - "bin/alpine/confd-alpine-amd64.tar.gz"
        - "bin/windows/confd-windows-386.zip"
    on:
        repo: yunify/confd
        tags: true

notifications:
  webhooks:
    urls:
      - https://webhooks.gitter.im/e/fbff60722b1e98fcdb93
    on_success: change  # options: [always|never|change] default: always
    on_failure: always  # options: [always|never|change] default: always
    on_start: never     # options: [always|never|change] default: always
